<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hey Nara - Wake Word Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .status.listening {
            background: #e3f2fd;
            color: #1976d2;
            border: 2px solid #2196f3;
        }
        .status.detected {
            background: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #4caf50;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .instructions {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ "Hey Nara" Wake Word Test</h1>

        <div class="instructions">
            <h3>How to test:</h3>
            <ol>
                <li>Click "Start Listening" to begin wake word detection</li>
                <li>Say <strong>"Hey Nara"</strong> clearly into your microphone</li>
                <li>Watch for the wake word detection event</li>
                <li>Try different variations: "Hey Nara", "Hi Nara", etc.</li>
            </ol>
        </div>

        <div id="status" class="status">
            Click "Start Listening" to begin
        </div>

        <div>
            <button id="startBtn" onclick="startListening()">Start Listening</button>
            <button id="stopBtn" onclick="stopListening()" disabled>Stop Listening</button>
            <button id="testBtn" onclick="triggerManual()">Manual Test</button>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        let wakeWordService = null;
        let isListening = false;

        // Simple Wake Word Detection using Web Speech API
        class SimpleWakeWordService {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.wakePhrase = 'hey nara';
                this.sensitivity = 0.6;
                this.onWakeWord = null;
                this.onError = null;
                this.onStatusChange = null;
            }

            async initialize() {
                log('Initializing wake word detection...');

                // Check for Web Speech API support
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    throw new Error('Web Speech API not supported in this browser');
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();

                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-US';

                this.recognition.onresult = (event) => {
                    const results = event.results;
                    const lastResult = results[results.length - 1];

                    if (lastResult.isFinal) {
                        const transcript = lastResult[0].transcript.toLowerCase().trim();
                        const confidence = lastResult[0].confidence || 0.8;

                        log(`Heard: "${transcript}" (confidence: ${Math.round(confidence * 100)}%)`);

                        if (transcript.includes(this.wakePhrase) && confidence >= this.sensitivity) {
                            this.triggerWakeWord(transcript, confidence);
                        }
                    }
                };

                this.recognition.onerror = (event) => {
                    log(`Speech recognition error: ${event.error}`, 'error');
                    if (this.onError) this.onError(event.error);

                    // Auto-restart on most errors
                    if (event.error !== 'not-allowed' && this.isListening) {
                        setTimeout(() => {
                            if (this.isListening) {
                                log('Restarting speech recognition...');
                                this.recognition.start();
                            }
                        }, 1000);
                    }
                };

                this.recognition.onend = () => {
                    if (this.isListening) {
                        log('Speech recognition ended, restarting...');
                        setTimeout(() => {
                            if (this.isListening) {
                                this.recognition.start();
                            }
                        }, 100);
                    }
                };

                log('Wake word detection initialized');
            }

            startListening() {
                if (this.isListening) return;

                log('üëÇ Starting to listen for "Hey Nara"...');
                this.isListening = true;

                try {
                    this.recognition.start();
                    if (this.onStatusChange) this.onStatusChange('listening');
                } catch (error) {
                    log(`Failed to start listening: ${error}`, 'error');
                    this.isListening = false;
                    throw error;
                }
            }

            stopListening() {
                if (!this.isListening) return;

                log('Stopping wake word detection');
                this.isListening = false;

                if (this.recognition) {
                    this.recognition.stop();
                }

                if (this.onStatusChange) this.onStatusChange('stopped');
            }

            triggerWakeWord(transcript, confidence) {
                log(`üéØ WAKE WORD DETECTED: "${transcript}" (${Math.round(confidence * 100)}%)`, 'success');

                if (this.onWakeWord) {
                    this.onWakeWord({
                        phrase: transcript,
                        confidence: confidence,
                        timestamp: Date.now()
                    });
                }

                if (this.onStatusChange) this.onStatusChange('detected');
            }

            triggerManual() {
                log('Manual wake word trigger');
                this.triggerWakeWord('hey nara (manual)', 1.0);
            }
        }

        async function startListening() {
            try {
                if (!wakeWordService) {
                    wakeWordService = new SimpleWakeWordService();

                    wakeWordService.onWakeWord = (detection) => {
                        updateStatus(`üéØ Wake word detected: "${detection.phrase}" (${Math.round(detection.confidence * 100)}%)`, 'detected');

                        // Simulate what would happen next
                        setTimeout(() => {
                            log('‚Üí Would pause Spotify now');
                            log('‚Üí Would start Vapi STT');
                            log('‚Üí Would process with LLM');
                            log('‚Üí Would synthesize TTS');
                            log('‚Üí Would resume Spotify');
                            updateStatus('üëÇ Listening for "Hey Nara"...', 'listening');
                        }, 2000);
                    };

                    wakeWordService.onError = (error) => {
                        updateStatus(`‚ùå Error: ${error}`, 'error');
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('stopBtn').disabled = true;
                        isListening = false;
                    };

                    wakeWordService.onStatusChange = (status) => {
                        if (status === 'listening') {
                            updateStatus('üëÇ Listening for "Hey Nara"...', 'listening');
                        } else if (status === 'stopped') {
                            updateStatus('Stopped listening', '');
                        }
                    };

                    await wakeWordService.initialize();
                }

                await wakeWordService.startListening();

                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                isListening = true;

            } catch (error) {
                log(`Failed to start: ${error}`, 'error');
                updateStatus(`‚ùå Failed to start: ${error}`, 'error');
            }
        }

        function stopListening() {
            if (wakeWordService) {
                wakeWordService.stopListening();
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            isListening = false;

            updateStatus('Stopped listening', '');
        }

        function triggerManual() {
            if (wakeWordService) {
                wakeWordService.triggerManual();
            } else {
                log('Start listening first before manual trigger', 'error');
            }
        }

        function updateStatus(message, type = '') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#00ff00';

            logEl.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Initialize log
        log('Wake word test ready. Click "Start Listening" to begin.');
    </script>
</body>
</html>

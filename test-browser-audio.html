<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vapi + ElevenLabs Audio Pipeline Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.ready { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.processing { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.speaking { background: #cce5ff; color: #004085; border: 1px solid #b3d7ff; }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.2s;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .config {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .config-item {
            margin: 5px 0;
            font-family: monospace;
        }

        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Vapi + ElevenLabs Audio Pipeline Test</h1>

        <div class="config">
            <h2>Configuration</h2>
            <div class="config-item">üîë Vapi API Key: 765f8644-****-****-****-************</div>
            <div class="config-item">ü§ñ Assistant ID: 9a887c78-****-****-****-************</div>
            <div class="config-item">üéµ ElevenLabs Key: sk_536c3f9a****************************</div>
            <div class="config-item">üó£Ô∏è Voice ID: XfWTl5ev8ylYnkKBEqnB</div>
        </div>

        <div id="status" class="status ready">
            üü¢ Ready to test audio pipeline
        </div>

        <div class="controls">
            <button id="testVapi" onclick="testVapiConnection()">Test Vapi Connection</button>
            <button id="testElevenLabs" onclick="testElevenLabsConnection()">Test ElevenLabs</button>
            <button id="testFullPipeline" onclick="testFullPipeline()">Test Full Pipeline</button>
            <button id="clearLog" onclick="clearLog()">Clear Log</button>
        </div>

        <h2>Test Log</h2>
        <div id="log" class="log">Ready to run tests...\n</div>
    </div>

    <script>
        // Configuration from your config.ts
        const CONFIG = {
            vapi: {
                apiKey: '765f8644-1464-4b36-a4fe-c660e15ba313',
                assistantId: '0bfc6364-690a-492b-9671-a109c5937342' // Nara STT-Only (fixed from old Riley)
            },
            elevenlabs: {
                apiKey: 'sk_536c3f9ad29e9e6e4f0b4aee762afa6d8db7d750d7f64587',
                voiceId: 'XfWTl5ev8ylYnkKBEqnB'
            }
        };

        let currentWebSocket = null;
        let currentAudio = null;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function setStatus(message, type = 'ready') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared...\n';
        }

        async function testVapiConnection() {
            log('üîå Testing Vapi Connection...');
            setStatus('üîÑ Testing Vapi connection...', 'processing');

            try {
                // Step 1: Test API key with assistant endpoint
                log('1. Testing API key authentication...');
                const response = await fetch(`https://api.vapi.ai/assistant/${CONFIG.vapi.assistantId}`, {
                    headers: {
                        'Authorization': `Bearer ${CONFIG.vapi.apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`API test failed: ${response.status} ${response.statusText}`);
                }

                const assistant = await response.json();
                log(`‚úÖ Assistant found: ${assistant.name}`);
                log(`   Model: ${assistant.model?.model}`);
                log(`   Voice: ${assistant.voice?.provider}`);

                // Step 2: Create WebSocket call
                log('2. Creating WebSocket call...');
                const callResponse = await fetch('https://api.vapi.ai/call', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.vapi.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assistantId: CONFIG.vapi.assistantId,
                        transport: {
                            provider: 'vapi.websocket',
                            audioFormat: {
                                format: 'pcm_s16le',
                                container: 'raw',
                                sampleRate: 16000
                            }
                        }
                    })
                });

                if (!callResponse.ok) {
                    throw new Error(`Call creation failed: ${callResponse.status}`);
                }

                const callData = await callResponse.json();
                log(`‚úÖ Call created: ${callData.id}`);

                // Step 3: Test WebSocket connection
                log('3. Testing WebSocket connection...');
                return new Promise((resolve, reject) => {
                    const ws = new WebSocket(callData.transport.websocketCallUrl);
                    let connected = false;
                    let messageCount = 0;

                    const timeout = setTimeout(() => {
                        if (!connected) {
                            ws.close();
                            reject(new Error('WebSocket connection timeout'));
                        }
                    }, 10000);

                    ws.onopen = () => {
                        connected = true;
                        log('‚úÖ WebSocket connected successfully');

                        setTimeout(() => {
                            clearTimeout(timeout);
                            ws.close();
                            log(`‚úÖ Vapi test complete (${messageCount} messages received)`);
                            setStatus('‚úÖ Vapi connection working!', 'ready');
                            resolve(true);
                        }, 3000);
                    };

                    ws.onmessage = (event) => {
                        messageCount++;
                        if (messageCount <= 3) {
                            try {
                                const message = JSON.parse(event.data);
                                log(`üì• Message: ${message.type || 'audio_data'}`);
                            } catch (e) {
                                log(`üì• Audio data received (${event.data.length} bytes)`);
                            }
                        }
                    };

                    ws.onerror = (error) => {
                        clearTimeout(timeout);
                        reject(new Error('WebSocket connection failed'));
                    };

                    currentWebSocket = ws;
                });

            } catch (error) {
                log(`‚ùå Vapi test failed: ${error.message}`);
                setStatus('‚ùå Vapi connection failed', 'error');
                throw error;
            }
        }

        async function testElevenLabsConnection() {
            log('üéµ Testing ElevenLabs Connection...');
            setStatus('üîÑ Testing ElevenLabs...', 'processing');

            try {
                // Step 1: Test API key
                log('1. Testing ElevenLabs API key...');
                const voicesResponse = await fetch('https://api.elevenlabs.io/v1/voices', {
                    headers: {
                        'xi-api-key': CONFIG.elevenlabs.apiKey
                    }
                });

                if (!voicesResponse.ok) {
                    throw new Error(`ElevenLabs API test failed: ${voicesResponse.status}`);
                }

                const voices = await voicesResponse.json();
                log(`‚úÖ API key valid (${voices.voices.length} voices available)`);

                // Step 2: Test specific voice
                log('2. Testing configured voice...');
                const voice = voices.voices.find(v => v.voice_id === CONFIG.elevenlabs.voiceId);
                if (voice) {
                    log(`‚úÖ Voice found: ${voice.name}`);
                } else {
                    log(`‚ö†Ô∏è Voice ID not found, using default`);
                }

                // Step 3: Test TTS generation
                log('3. Testing TTS generation...');
                const ttsResponse = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${CONFIG.elevenlabs.voiceId}`, {
                    method: 'POST',
                    headers: {
                        'xi-api-key': CONFIG.elevenlabs.apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: "Hello! This is a test of the ElevenLabs integration for your audiobook copilot.",
                        model_id: "eleven_turbo_v2",
                        voice_settings: {
                            stability: 0.75,
                            similarity_boost: 0.8,
                            style: 0.2,
                            use_speaker_boost: true
                        }
                    })
                });

                if (!ttsResponse.ok) {
                    throw new Error(`TTS generation failed: ${ttsResponse.status}`);
                }

                const audioBlob = await ttsResponse.blob();
                log(`‚úÖ TTS generated (${audioBlob.size} bytes)`);

                // Step 4: Play the audio
                log('4. Playing generated audio...');
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);

                return new Promise((resolve) => {
                    audio.onended = () => {
                        log('‚úÖ Audio playback complete');
                        setStatus('‚úÖ ElevenLabs working!', 'ready');
                        URL.revokeObjectURL(audioUrl);
                        resolve(true);
                    };

                    audio.onerror = () => {
                        log('‚ùå Audio playback failed');
                        setStatus('‚ùå Audio playback failed', 'error');
                        resolve(false);
                    };

                    setStatus('üîä Playing TTS audio...', 'speaking');
                    audio.play();
                    currentAudio = audio;
                });

            } catch (error) {
                log(`‚ùå ElevenLabs test failed: ${error.message}`);
                setStatus('‚ùå ElevenLabs connection failed', 'error');
                throw error;
            }
        }

        async function testFullPipeline() {
            log('üöÄ Testing Full Audio Pipeline...');
            setStatus('üîÑ Running full pipeline test...', 'processing');

            try {
                // Test both services
                log('=== TESTING VAPI ===');
                await testVapiConnection();

                log('\n=== TESTING ELEVENLABS ===');
                await testElevenLabsConnection();

                log('\n=== PIPELINE TEST COMPLETE ===');
                log('‚úÖ Both Vapi and ElevenLabs are working!');
                log('‚úÖ Your audio pipeline is ready for integration');

                setStatus('üéâ Full pipeline test passed!', 'ready');

                // Show next steps
                log('\nüìã Next Steps:');
                log('1. Install bun: curl -fsSL https://bun.sh/install | bash');
                log('2. Run: bun run dev');
                log('3. Test in Electron app with microphone access');
                log('4. Integrate with AudioManager for real-time voice');

            } catch (error) {
                log(`‚ùå Pipeline test failed: ${error.message}`);
                setStatus('‚ùå Pipeline test failed', 'error');
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentWebSocket) {
                currentWebSocket.close();
            }
            if (currentAudio) {
                currentAudio.pause();
            }
        });

        // Initial log
        log('üé§ Audio Pipeline Test Ready');
        log('Click "Test Full Pipeline" to test both Vapi and ElevenLabs');
    </script>
</body>
</html>
